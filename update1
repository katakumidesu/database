-- Create DB and select it
CREATE DATABASE IF NOT EXISTS katakumi
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
USE katakumi;

-- USERS
CREATE TABLE IF NOT EXISTS users (
  user_id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  username VARCHAR(100) DEFAULT NULL,
  email VARCHAR(255) NOT NULL,
  phone VARCHAR(32) DEFAULT NULL,
  gender VARCHAR(20) DEFAULT NULL,
  birthdate DATE DEFAULT NULL,
  profile_image VARCHAR(255) DEFAULT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'user',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uq_users_email (email),
  UNIQUE KEY uq_users_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- CATEGORIES
CREATE TABLE IF NOT EXISTS categories (
  category_id INT AUTO_INCREMENT PRIMARY KEY,
  category_name VARCHAR(255) NOT NULL,
  UNIQUE KEY uq_categories_name (category_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- PRODUCTS
CREATE TABLE IF NOT EXISTS products (
  product_id INT AUTO_INCREMENT PRIMARY KEY,
  category_id INT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  stock INT NOT NULL DEFAULT 0,
  image_url VARCHAR(255) DEFAULT NULL,
  rating DECIMAL(2,1) DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_products_name (name),
  INDEX idx_products_category (category_id),
  CONSTRAINT fk_products_category
    FOREIGN KEY (category_id) REFERENCES categories(category_id)
    ON UPDATE CASCADE
    ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ORDERS (keeps your columns + adds a canonical 'total' used by the app)
CREATE TABLE IF NOT EXISTS orders (
  order_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  customer_name VARCHAR(255) DEFAULT NULL,
  customer_phone VARCHAR(32) DEFAULT NULL,
  date DATETIME DEFAULT CURRENT_TIMESTAMP,
  status VARCHAR(20) NOT NULL DEFAULT 'to_pay',
  total_amount DECIMAL(10,2) DEFAULT NULL,     -- your column
  total DECIMAL(10,2) DEFAULT NULL,            -- app’s canonical column (optional but helpful)
  INDEX idx_orders_user (user_id),
  INDEX idx_orders_date (date),
  INDEX idx_orders_status (status),
  CONSTRAINT fk_orders_user
    FOREIGN KEY (user_id) REFERENCES users(user_id)
    ON UPDATE CASCADE
    ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ORDER ITEMS (matches screenshots: product_name stored here)
CREATE TABLE IF NOT EXISTS order_items (
  item_id INT AUTO_INCREMENT PRIMARY KEY,
  order_id INT NOT NULL,
  product_name VARCHAR(255) NOT NULL,
  quantity INT NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  image_url VARCHAR(255) DEFAULT NULL,
  INDEX idx_items_order (order_id),
  CONSTRAINT fk_items_order
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
    ON UPDATE CASCADE
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ORDERDETAILS (you have this table too; keep it for legacy compatibility)
CREATE TABLE IF NOT EXISTS orderdetails (
  order_table_id INT AUTO_INCREMENT PRIMARY KEY,
  order_id INT NOT NULL,
  product_id INT NOT NULL,
  quantity INT NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  INDEX idx_orderdetails_order (order_id),
  INDEX idx_orderdetails_product (product_id),
  CONSTRAINT fk_orderdetails_order
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
    ON UPDATE CASCADE
    ON DELETE CASCADE,
  CONSTRAINT fk_orderdetails_product
    FOREIGN KEY (product_id) REFERENCES products(product_id)
    ON UPDATE CASCADE
    ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- PAYMENTS (present in your DB; app does not query it, but keep as-is)
CREATE TABLE IF NOT EXISTS payments (
  payment_id INT AUTO_INCREMENT PRIMARY KEY,
  order_id INT NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  payment_date DATETIME DEFAULT CURRENT_TIMESTAMP,
  method VARCHAR(30) DEFAULT NULL,
  INDEX idx_payments_order (order_id),
  CONSTRAINT fk_payments_order
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
    ON UPDATE CASCADE
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- DELIVERY (present in your DB; app does not query it, but keep as-is)
CREATE TABLE IF NOT EXISTS delivery (
  delivery_id INT AUTO_INCREMENT PRIMARY KEY,
  order_id INT NOT NULL,
  address VARCHAR(255) DEFAULT NULL,
  city VARCHAR(128) DEFAULT NULL,
  barangay VARCHAR(128) DEFAULT NULL,
  postal_code VARCHAR(32) DEFAULT NULL,
  country VARCHAR(64) DEFAULT 'PH',
  delivery_date DATETIME DEFAULT NULL,
  status VARCHAR(32) DEFAULT 'pending',
  INDEX idx_delivery_order (order_id),
  CONSTRAINT fk_delivery_order
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
    ON UPDATE CASCADE
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- USER ADDRESSES (your table shows address + zone; app uses address_line + barangay)
-- Keep both to support your data and the app’s forms.
CREATE TABLE IF NOT EXISTS user_addresses (
  address_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  fullname VARCHAR(255) DEFAULT '',
  phone VARCHAR(64) DEFAULT '',
  -- Your older columns
  address VARCHAR(255) DEFAULT NULL,
  zone VARCHAR(64) DEFAULT NULL,
  -- App-preferred columns
  label VARCHAR(32) DEFAULT 'Home',
  address_line VARCHAR(255) DEFAULT '',
  barangay VARCHAR(128) DEFAULT '',
  city VARCHAR(128) DEFAULT '',
  province VARCHAR(128) DEFAULT '',
  postal_code VARCHAR(32) DEFAULT '',
  is_default TINYINT(1) DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_addr_user (user_id),
  INDEX idx_addr_default (is_default),
  CONSTRAINT fk_addresses_user
    FOREIGN KEY (user_id) REFERENCES users(user_id)
    ON UPDATE CASCADE
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- OPTIONAL: backfill canonical orders.total from total_amount or order_items if missing
UPDATE orders o
SET o.total = COALESCE(
  o.total,
  o.total_amount,
  (SELECT SUM(oi.quantity * oi.price)
   FROM order_items oi
   WHERE oi.order_id = o.order_id)
);

-- OPTIONAL: ensure status values are normalized (the app also normalizes in SELECTs)
-- You can keep as-is; not strictly required.
